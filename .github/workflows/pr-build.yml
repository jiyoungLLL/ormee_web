name: PR Build Status Check

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  build:
    name: ğŸ› ï¸ í”„ë¡œì íŠ¸ ë¹Œë“œ
    runs-on: ubuntu-latest
    outputs:
      nextjs_build_result: ${{ steps.test_results.outputs.nextjs_build_result }}
      storybook_build_result: ${{ steps.test_results.outputs.storybook_build_result }}
      storybook_test_result: ${{ steps.test_results.outputs.storybook_test_result }}
      error_summary: ${{ steps.error.outputs.summary }}
      build_success: ${{ steps.final_status.outputs.build_success }}

    steps:
      # âœ… PR ë¸Œëœì¹˜ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v3

      # âœ… pnpm ì„¤ì¹˜
      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: 8

      # âœ… Node.js ì„¤ì¹˜
      - name: Node.js ì„¤ì¹˜
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # âœ… ì˜ì¡´ì„± ì„¤ì¹˜
      - name: íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: pnpm install

      # âœ… Next.js ë¹Œë“œ ì‹¤í–‰
      - name: ğŸ”¨ Next.js ë¹Œë“œ
        id: nextbuild
        continue-on-error: true
        run: |
          set -o pipefail
          pnpm build 2>&1 | tee build.log
          exit ${PIPESTATUS[0]}

      # âœ… ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰ ì—¬ë¶€ í™•ì¸
      - name: Next.js ë¹Œë“œ ê²°ê³¼ í™•ì¸
        id: build_check
        run: |
          if [[ "${{ steps.nextbuild.outcome }}" == "success" ]]; then
            echo "should_continue=true" >> $GITHUB_OUTPUT
          else
            echo "should_continue=false" >> $GITHUB_OUTPUT
          fi

      # âœ… Storybookì„ ì •ì ìœ¼ë¡œ ë¹Œë“œ (storybook-static í´ë”ì— ì¶œë ¥)
      - name: ğŸ“¦ Storybook ì •ì  ë¹Œë“œ
        id: storybookbuild
        if: steps.build_check.outputs.should_continue == 'true'
        continue-on-error: true
        run: pnpm build-storybook -o storybook-static

      # âœ… Storybook ì„œë²„ ì‹¤í–‰ ë° ì‘ë‹µ ëŒ€ê¸° (ìµœëŒ€ 5ë¶„, 5ì´ˆë§ˆë‹¤ ìƒíƒœ ì¶œë ¥)
      - name: ğŸš€ Storybook ì„œë²„ ì‹¤í–‰ ë° ëŒ€ê¸°
        id: storybookserver
        if: steps.build_check.outputs.should_continue == 'true' && steps.storybookbuild.outcome == 'success'
        continue-on-error: true
        run: |
          npx serve storybook-static --no-clipboard -l 6006 > storybook-server.log 2>&1 &
          server_started=false
          for i in {1..60}; do
            if curl -s http://localhost:6006 > /dev/null; then
              echo "âœ… Storybook ì„œë²„ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!"
              server_started=true
              break
            else
              echo "â³ Storybook ì„œë²„ ëŒ€ê¸° ì¤‘... ($i/60)"
              sleep 5
            fi
          done
          if [ "$server_started" = false ]; then
            echo "âŒ Storybook ì„œë²„ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi

      # âœ… Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜
      - name: ğŸ­ Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜
        if: steps.build_check.outputs.should_continue == 'true' && steps.storybookserver.outcome == 'success'
        continue-on-error: true
        run: pnpm exec playwright install --with-deps chromium

      # âœ… Storybook í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì •ì  ì„œë²„ì— ëŒ€í•´)
      - name: ğŸ§ª Storybook í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        id: storybooktest
        if: steps.build_check.outputs.should_continue == 'true' && steps.storybookserver.outcome == 'success'
        continue-on-error: true
        run: |
          pnpm test-storybook --url http://localhost:6006 --failOnError 2>&1 | tee storybook-test.log
          exit ${PIPESTATUS[0]}

      # âŒ ì‹¤íŒ¨í•œ ê²½ìš° ë¡œê·¸ì—ì„œ ì˜¤ë¥˜ ìš”ì•½ ì¶”ì¶œ
      - name: ğŸ“‹ ì˜¤ë¥˜ ìš”ì•½ ì¶”ì¶œ
        id: error
        if: always()
        run: |
          echo "ğŸ“¦ ì˜¤ë¥˜ ë¡œê·¸ ìš”ì•½ì„ ì¶”ì¶œí•©ë‹ˆë‹¤..."
          ERROR_LOGS=""
          if [ -f "build.log" ]; then
            ERROR_LOGS="$ERROR_LOGS build.log"
          fi
          if [ -f "storybook-test.log" ]; then
            ERROR_LOGS="$ERROR_LOGS storybook-test.log"
          fi

          if [ -z "$ERROR_LOGS" ]; then
            echo "ë¡œê·¸ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            echo "summary=ë¡œê·¸ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
          else
            tail -n 50 $ERROR_LOGS > error-tail.log
            SUMMARY=$(grep -i -E "error|failed|unexpected|cannot|not found" error-tail.log | tail -n 10 | sed 's/^/> /')
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      # í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ outputsì— ì €ì¥
      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì €ì¥
        if: always()
        id: test_results
        run: |
          # Next.js ë¹Œë“œ ê²°ê³¼
          if [[ "${{ steps.nextbuild.outcome }}" == "success" ]]; then
            echo "nextjs_build_result=success" >> $GITHUB_OUTPUT
          else
            echo "nextjs_build_result=failure" >> $GITHUB_OUTPUT
          fi

          # Storybook ë¹Œë“œ ê²°ê³¼
          if [[ "${{ steps.storybookbuild.outcome }}" == "success" ]]; then
            echo "storybook_build_result=success" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.storybookbuild.outcome }}" == "skipped" || "${{ steps.build_check.outputs.should_continue }}" == "false" ]]; then
            echo "storybook_build_result=skipped" >> $GITHUB_OUTPUT
          else
            echo "storybook_build_result=failure" >> $GITHUB_OUTPUT
          fi

          # Storybook í…ŒìŠ¤íŠ¸ ê²°ê³¼
          if [[ "${{ steps.storybooktest.outcome }}" == "success" ]]; then
            echo "storybook_test_result=success" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.storybooktest.outcome }}" == "skipped" || "${{ steps.build_check.outputs.should_continue }}" == "false" || "${{ steps.storybookserver.outcome }}" != "success" ]]; then
            echo "storybook_test_result=skipped" >> $GITHUB_OUTPUT
          else
            echo "storybook_test_result=failure" >> $GITHUB_OUTPUT
          fi

      # ìµœì¢… ë¹Œë“œ ìƒíƒœ ê²°ì •
      - name: ìµœì¢… ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ìƒíƒœ ê²°ì •
        id: final_status
        if: always()
        run: |
          if [[ "${{ steps.nextbuild.outcome }}" == "success" && \
                "${{ steps.storybookbuild.outcome }}" == "success" && \
                "${{ steps.storybooktest.outcome }}" == "success" ]]; then
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
          fi

      # ì‹¤íŒ¨ ìƒíƒœë¡œ ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ (PRì— X í‘œì‹œ ë‚˜íƒ€ë‚˜ê²Œ í•¨)
      - name: ë¹Œë“œ ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì²˜ë¦¬
        if: always() && steps.final_status.outputs.build_success != 'true'
        run: |
          echo "âŒ ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤íŒ¨ ìƒíƒœë¡œ ì¢…ë£Œí•©ë‹ˆë‹¤."
          exit 1

  comment:
    name: ğŸ’¬ PRì— ê²°ê³¼ ëŒ“ê¸€ ì‘ì„±
    runs-on: ubuntu-latest
    needs: build
    if: always()

    steps:
      # âœ… PRì— ê²°ê³¼ ëŒ“ê¸€ ì‘ì„± (ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘ ì²˜ë¦¬)
      - name: ê²°ê³¼ ëŒ“ê¸€ ì‘ì„±
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: build-status
          message: |
            ${{ (needs.build.outputs.nextjs_build_result == 'success' && needs.build.outputs.storybook_build_result == 'success' && needs.build.outputs.storybook_test_result == 'success') && 'âœ… **Next.js & Storybook ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì„±ê³µ** ğŸ‰' || 'âŒ **ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨**' }}

            ### ğŸ“Š ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ìš”ì•½

            - **Next.js Build**: ${{ needs.build.outputs.nextjs_build_result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}
            - **Storybook ë¹Œë“œ**: ${{ needs.build.outputs.storybook_build_result == 'success' && 'âœ… ì„±ê³µ' || (needs.build.outputs.storybook_build_result == 'skipped' && 'âš ï¸ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ' || 'âŒ ì‹¤íŒ¨') }}
            - **Storybook í…ŒìŠ¤íŠ¸ ì‹¤í–‰**: ${{ needs.build.outputs.storybook_test_result == 'success' && 'âœ… ì„±ê³µ' || (needs.build.outputs.storybook_test_result == 'skipped' && 'âš ï¸ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ' || 'âŒ ì‹¤íŒ¨') }}

            ${{ needs.build.outputs.error_summary && format('**ì˜¤ë¥˜ ìš”ì•½:**\n```\n{0}\n```', needs.build.outputs.error_summary) }}

            > ğŸ” ë¡œì»¬ì—ì„œ ì¬í˜„í•˜ë ¤ë©´ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•´ë³´ì„¸ìš”:
            ```bash
            pnpm install
            pnpm build
            pnpm build-storybook -o storybook-static
            npx serve storybook-static -l 6006
            pnpm test-storybook --url http://localhost:6006
            ```
