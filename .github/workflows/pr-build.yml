name: PR Build Status Check

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  build:
    name: ğŸ› ï¸ í”„ë¡œì íŠ¸ ë¹Œë“œ
    runs-on: ubuntu-latest
    outputs:
      storybook_test_result: ${{ steps.test_results.outputs.storybook_test_result }}

    steps:
      # âœ… PR ë¸Œëœì¹˜ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v3

      # âœ… pnpm ì„¤ì¹˜
      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: 8

      # âœ… Node.js ì„¤ì¹˜
      - name: Node.js ì„¤ì¹˜
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # âœ… ì˜ì¡´ì„± ì„¤ì¹˜
      - name: íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: pnpm install

      # âœ… Next.js ë¹Œë“œ ì‹¤í–‰
      - name: ğŸ”¨ Next.js ë¹Œë“œ
        id: nextbuild
        run: |
          set -o pipefail
          pnpm build 2>&1 | tee build.log

      # âœ… Storybookì„ ì •ì ìœ¼ë¡œ ë¹Œë“œ (storybook-static í´ë”ì— ì¶œë ¥)
      - name: ğŸ“¦ Storybook ì •ì  ë¹Œë“œ
        run: pnpm build-storybook -o storybook-static

      # âœ… Storybook ì„œë²„ ì‹¤í–‰ ë° ì‘ë‹µ ëŒ€ê¸° (ìµœëŒ€ 5ë¶„, 5ì´ˆë§ˆë‹¤ ìƒíƒœ ì¶œë ¥)
      - name: ğŸš€ Storybook ì„œë²„ ì‹¤í–‰ ë° ëŒ€ê¸°
        run: |
          npx serve storybook-static --no-clipboard -l 6006 > storybook-server.log 2>&1 &
          for i in {1..60}; do
            if curl -s http://localhost:6006 > /dev/null; then
              echo "âœ… Storybook ì„œë²„ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!"
              break
            else
              echo "â³ Storybook ì„œë²„ ëŒ€ê¸° ì¤‘... ($i/60)"
              sleep 5
            fi
          done

      # âœ… Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜
      - name: ğŸ­ Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜
        run: pnpm exec playwright install --with-deps chromium

      # âœ… Storybook í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì •ì  ì„œë²„ì— ëŒ€í•´)
      - name: ğŸ§ª Storybook í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        id: storybooktest
        run: |
          pnpm test-storybook --url http://localhost:6006 2>&1 | tee storybook-test.log

      # âŒ ì‹¤íŒ¨í•œ ê²½ìš° ë¡œê·¸ì—ì„œ ì˜¤ë¥˜ ìš”ì•½ ì¶”ì¶œ
      - name: ğŸ“‹ ì˜¤ë¥˜ ìš”ì•½ ì¶”ì¶œ
        id: error
        if: failure()
        run: |
          echo "ğŸ“¦ ì˜¤ë¥˜ ë¡œê·¸ ìš”ì•½ì„ ì¶”ì¶œí•©ë‹ˆë‹¤..."
          tail -n 50 build.log storybook-test.log > error-tail.log
          SUMMARY=$(grep -i -E "error|failed|unexpected|cannot|not found" error-tail.log | tail -n 10 | sed 's/^/> /')
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ outputsì— ì €ì¥
      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì €ì¥
        if: always()
        id: test_results
        run: echo "storybook_test_result=${{ steps.storybooktest.outcome }}" >> $GITHUB_OUTPUT

  comment:
    name: ğŸ’¬ PRì— ê²°ê³¼ ëŒ“ê¸€ ì‘ì„±
    runs-on: ubuntu-latest
    needs: build

    steps:
      # âœ… PRì— ê²°ê³¼ ëŒ“ê¸€ ì‘ì„± (ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘ ì²˜ë¦¬)
      - name: ê²°ê³¼ ëŒ“ê¸€ ì‘ì„±
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: build-status
          message: |
            ${{ needs.build.result == 'success' && 'âœ… **Next.js & Storybook ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì„±ê³µ** ğŸ‰' || 'âŒ **ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨**' }}

            ### ğŸ“Š ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ìš”ì•½

            - **Next.js Build**: ${{ needs.build.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}
            - **Storybook í…ŒìŠ¤íŠ¸ ì‹¤í–‰**: ${{ needs.build.outputs.storybook_test_result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}

            ${{ steps.error.outputs.summary && format('**ì˜¤ë¥˜ ìš”ì•½:**\n```\n{0}\n```', steps.error.outputs.summary) }}

            > ğŸ” ë¡œì»¬ì—ì„œ ì¬í˜„í•˜ë ¤ë©´ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•´ë³´ì„¸ìš”:
            ```bash
            pnpm install
            pnpm build
            pnpm build-storybook -o storybook-static
            npx serve storybook-static -l 6006
            pnpm test-storybook --url http://localhost:6006
            ```
